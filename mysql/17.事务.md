## 什么是事务？
> 事务是在数据库上按照一定的逻辑顺序执行的任务序列，简单得说，保证一组任务得结果，要么都成功，要么都失败。

### 经典案例
> 银行转账，a向b转500块钱，那么，要么成功，a 少500，b 多500；要么失败，a,b 都不变。不可存在中间状态。

### 事务的属性
> 事务具有以下四个标准属性，通常用缩略词 ACID 来表示：
#### 原子性
* 保证任务中的所有操作都执行完毕；否则，事务会在出现错误时终止，并回滚之前所有操作到原始状态。
* 简单的说，要么都成功，要么都失败。
#### 一致性
* 如果事务成功执行，则数据库的状态得到了进行了正确的转变。
* 简单的说，事务前后的数据完整性要保持一致，如，转账前，a,b 的总金额是1000，转账后，也是 1000。
#### 隔离性
* 保证不同的事务相互独立、透明地执行。
* 十五的隔离性是多个用户并发访问数据库是，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离。
#### 持久性
* 即使出现系统故障，之前成功执行的事务的结果也会持久存在。
* 事务一旦提交，则不可逆，被持久化到数据库中。

### 隔离所导致的一些问题
* 脏读： 一个事务读取了另外一个事务未提交的数据。

* 不可重复读：在一个事务内，读取表中的某一行数据，多次读取结果不同（这个不一定是错误，只是某些场合不对）。

* 虚读（幻读）： 在一个事务内读取到了别的事务插入的数据，导致前后读取不一致。


### 执行事务的基本流程
> mysql 是默认开启事务自动提交的。

```sql
-- 手动处理事务
SET autocommit = 0 -- 关闭自动提交

-- 进行一系列操作
INSERT xxx
INSERT xxx

-- 保存点，类似于游戏的存档（了解）
SAVEPOINT 保存点 -- 设置一个事务的保存点
ROLLBACK to SAVEPOINT 保存点 -- 回滚到保存点
RELEASE SAVEPOINT 保存点  -- 释放保存点

-- 事务执行成功，则提交（持久化）
COMMIT

-- 事务执行失败，则回滚到原来的样子。
ROLLBACK

-- 事务结束，
SET autocommit = 1 -- 开启自动提交 （默认）
```

### 示例
```sql
-- 关闭自动提交
SET autocommit = 0

-- 事务流程
START TRANSACTION

-- 开启事务后，要执行的操作
UPDATE `account` SET `money`='1000.00' WHERE `name`='A'
UPDATE `account` SET `money`='1000.00' WHERE `name`='B'

-- 如果所有操作执行成功了，则可以 commit 来持久化数据
COMMIT

-- 如果有任何一个操作执行失败，则将数据回滚到刚开始时的状态
ROLLBACK

-- 开启自动提交
SET autocommit = 1
```